---
import Layout from '../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

// Get all firmware entries, excluding files starting with underscore (drafts/examples)
const allFirmware = await getCollection('firmware', ({ id }) => !id.startsWith('_'));

// Sort by date, newest first
const firmware = allFirmware.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<Layout>
	<div class="container mx-auto px-4 py-8 max-w-4xl">
		<!-- Header -->
		<div class="mb-8">
			<a href="/" class="text-blue-500 hover:underline text-sm">&larr; Back to guide</a>
			<h1 class="text-4xl font-bold mt-4 mb-4">Custom Firmware</h1>
			<p class="text-xl text-gray-600">
				Download custom firmware packages to unlock new features on your Super73 ebike.
			</p>
		</div>

		<!-- Important Warning -->
		<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
			<div class="flex">
				<div class="shrink-0">
					<svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
						<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
					</svg>
				</div>
				<div class="ml-3">
					<h3 class="text-sm font-medium text-yellow-800">Important</h3>
					<p class="text-sm text-yellow-700 mt-1">
						<strong>Always backup your original firmware first!</strong> Custom firmware is provided as-is.
						Modifying your ebike's firmware may void your warranty and could affect compliance with local regulations.
					</p>
				</div>
			</div>
		</div>

		{firmware.length > 0 ? (
			<!-- Firmware List -->
			<section class="mb-12">
				<h2 class="text-2xl font-bold mb-4">Available Firmware</h2>
				<div class="space-y-6">
					{firmware.map(async (fw) => {
						const { Content } = await fw.render();
						return (
							<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
								<div class="p-6">
									<div class="flex justify-between items-start mb-4">
										<div>
											<div class="flex items-center gap-2">
												<h3 class="text-xl font-semibold">{fw.data.name}</h3>
												<span class="text-sm text-gray-500 font-mono">v{fw.data.version}</span>
												{fw.data.experimental && (
													<span class="px-2 py-0.5 text-xs font-medium bg-orange-100 text-orange-800 rounded">
														Experimental
													</span>
												)}
											</div>
											<p class="text-gray-600 mt-1">{fw.data.description}</p>
										</div>
										<a
											href={fw.data.path}
											download
											class="shrink-0 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
										>
											Download
										</a>
									</div>

									<div class="flex flex-wrap gap-4 text-sm text-gray-500 mb-4">
										<span>Released: {fw.data.date.toLocaleDateString()}</span>
										{fw.data.compatibility && fw.data.compatibility.length > 0 && (
											<span>Compatible: {fw.data.compatibility.join(', ')}</span>
										)}
									</div>

									<details class="text-sm">
										<summary class="cursor-pointer text-blue-500 hover:text-blue-600 select-none font-medium">
											View details
										</summary>
										<div class="mt-4 prose prose-sm max-w-none prose-headings:text-gray-900 prose-p:text-gray-600 prose-li:text-gray-600 prose-strong:text-gray-900">
											<Content />
										</div>
									</details>
								</div>
							</div>
						);
					})}
				</div>
			</section>
		) : (
			<!-- Coming Soon Notice -->
			<div class="bg-blue-50 border-l-4 border-blue-400 p-6 mb-8">
				<div class="flex">
					<div class="shrink-0">
						<svg class="h-6 w-6 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
						</svg>
					</div>
					<div class="ml-4">
						<h2 class="text-lg font-semibold text-blue-800">Coming Soon</h2>
						<p class="text-blue-700 mt-1">
							Custom firmware packages are currently in development. Check back later for downloadable firmware with enhanced features.
						</p>
					</div>
				</div>
			</div>
		)}

		<!-- How It Works -->
		<section class="mb-12">
			<h2 class="text-2xl font-bold mb-4">How to Flash Custom Firmware</h2>
			<div class="bg-white border border-gray-200 rounded-lg p-6">
				<ol class="space-y-4">
					<li class="flex items-start">
						<span class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-4">1</span>
						<div>
							<strong class="text-gray-900">Backup your original firmware</strong>
							<p class="text-gray-600 text-sm">Always create a backup first using the <a href="/" class="text-blue-500 hover:underline">guided tutorial</a>. Keep this file safe!</p>
						</div>
					</li>
					<li class="flex items-start">
						<span class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-4">2</span>
						<div>
							<strong class="text-gray-900">Download custom firmware</strong>
							<p class="text-gray-600 text-sm">Choose and download a firmware package from above.</p>
						</div>
					</li>
					<li class="flex items-start">
						<span class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-4">3</span>
						<div>
							<strong class="text-gray-900">Flash using the Restore tool</strong>
							<p class="text-gray-600 text-sm">Use the <a href="/advanced" class="text-blue-500 hover:underline">Restore tool</a> to flash the custom firmware to your device.</p>
						</div>
					</li>
				</ol>
			</div>
		</section>

		<!-- Stay Updated -->
		<section>
			<div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
				<h2 class="text-xl font-semibold mb-2">Stay Updated</h2>
				<p class="text-gray-600 mb-4">
					Join the community to get notified about new firmware releases.
				</p>
				<a
					href="https://reverse.bike"
					target="_blank"
					rel="noopener"
					class="inline-block px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
				>
					Visit reverse.bike
				</a>
			</div>
		</section>
	</div>
</Layout>
