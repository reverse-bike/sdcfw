---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import Callout from '../components/Callout';
import Icon from '../components/Icon';

// Get all firmware entries, excluding files starting with underscore (drafts/examples)
const allFirmware = await getCollection('firmware', ({ id }) => !id.startsWith('_'));

// Sort by date, newest first
const firmware = allFirmware.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
---

<Layout>
	<div class="container mx-auto px-4 py-8 max-w-4xl">
		<!-- Header -->
		<div class="mb-8">
			<a href="/" class="text-blue-500 hover:underline text-sm">&larr; Back to guide</a>
			<h1 class="text-4xl font-bold mt-4 mb-4">Custom Firmware</h1>
			<p class="text-xl text-gray-600">
				Download custom firmware packages to unlock new features on your Super73 ebike.
			</p>
		</div>

		<!-- Important Warning -->
		<div class="mb-8">
			<Callout type="warning" title="Important">
				<strong>Always backup your original firmware first!</strong> Custom firmware is provided as-is.
				Modifying your ebike's firmware may void your warranty and could affect compliance with local regulations.
			</Callout>
		</div>

		{firmware.length > 0 ? (
			<!-- Firmware List -->
			<section class="mb-12">
				<h2 class="text-2xl font-bold mb-4">Available Firmware</h2>
				<div class="space-y-6">
					{firmware.map(async (fw) => {
						const { Content } = await fw.render();
						return (
							<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
								<div class="p-6">
									<div class="flex justify-between items-start mb-4">
										<div>
											<div class="flex items-center gap-2">
												<h3 class="text-xl font-semibold">{fw.data.name}</h3>
												<span class="text-sm text-gray-500 font-mono">v{fw.data.version}</span>
												{fw.data.experimental && (
													<span class="px-2 py-0.5 text-xs font-medium bg-orange-100 text-orange-800 rounded">
														Experimental
													</span>
												)}
											</div>
											<p class="text-gray-600 mt-1">{fw.data.description}</p>
										</div>
										<a
											href={fw.data.path}
											download
											class="shrink-0 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
										>
											Download
										</a>
									</div>

									<div class="flex flex-wrap gap-4 text-sm text-gray-500 mb-4">
										<span>Released: {fw.data.date.toLocaleDateString()}</span>
										{fw.data.compatibility && fw.data.compatibility.length > 0 && (
											<span>Compatible: {fw.data.compatibility.join(', ')}</span>
										)}
									</div>

									<details class="text-sm">
										<summary class="cursor-pointer text-blue-500 hover:text-blue-600 select-none font-medium">
											View details
										</summary>
										<div class="mt-4 prose prose-sm max-w-none prose-headings:text-gray-900 prose-p:text-gray-600 prose-li:text-gray-600 prose-strong:text-gray-900">
											<Content />
										</div>
									</details>
								</div>
							</div>
						);
					})}
				</div>
			</section>
		) : (
			<!-- Coming Soon Notice -->
			<div class="bg-blue-50 border-l-4 border-blue-400 p-6 mb-8">
				<div class="flex">
					<div class="shrink-0">
						<Icon type="info" class="h-6 w-6 text-blue-400" />
					</div>
					<div class="ml-4">
						<h2 class="text-lg font-semibold text-blue-800">Coming Soon</h2>
						<p class="text-blue-700 mt-1">
							Custom firmware packages are currently in development. Check back later for downloadable firmware with enhanced features.
						</p>
					</div>
				</div>
			</div>
		)}

		<!-- How It Works -->
		<section class="mb-12">
			<h2 class="text-2xl font-bold mb-4">How to Flash Custom Firmware</h2>
			<div class="bg-white border border-gray-200 rounded-lg p-6">
				<ol class="space-y-4">
					<li class="flex items-start">
						<span class="shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-4">1</span>
						<div>
							<strong class="text-gray-900">Download custom firmware</strong>
							<p class="text-gray-600 text-sm">Choose and download a firmware package from above.</p>
						</div>
					</li>
					<li class="flex items-start">
						<span class="shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-4">2</span>
						<div>
							<strong class="text-gray-900">Follow the guide</strong>
							<p class="text-gray-600 text-sm">Use the <a href="/" class="text-blue-500 hover:underline">step-by-step guide</a> to backup your original firmware and flash the custom firmware using the Restore tool.</p>
						</div>
					</li>
				</ol>
			</div>
		</section>

		<!-- Stay Updated -->
		<section>
			<div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
				<h2 class="text-xl font-semibold mb-2">Stay Updated</h2>
				<p class="text-gray-600 mb-4">
					Join the community to get notified about new firmware releases.
				</p>
				<a
					href="https://reverse.bike"
					target="_blank"
					rel="noopener"
					class="inline-block px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
				>
					Visit reverse.bike
				</a>
			</div>
		</section>
	</div>
</Layout>
